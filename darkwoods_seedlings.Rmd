---
title: "Spatial Point Process Model of Seedling Patterns; Darkwoods Conservation Area"
author: "SMurphy"
date: "2021-01-30"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE, message = FALSE}
#install.packages(c("readxl", "sf", "kernlab", "ggplot2", "dplyr", 
 #                  "RColorBrewer", "psych", "useful", "caret", 
  #                 "tibble", "klaR", "ModelMetrics", "DescTools", 
   #                "MLmetrics", "coefplot", "glmnet", "jsonlite", "plotly", "RSQLite", "tidyverse", "useful", "xgboost"), dependencies=TRUE)
library(coefplot)
library(glmnet)
library(formatR)
#library(jsonlite)
#library(plotly)
#library(tidyverse)
#library(useful)
#library(xgboost)
library(readxl)
library(sf)
library(kernlab)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(useful)
library(caret)
library(tibble)
library(klaR)
library(ModelMetrics)
library(DescTools)
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      comment = NA,tidy.opts=list(width.cutoff=60),tidy=TRUE)
options(knitr.table.format = "html") 
```

## Import

Seed set to `123` for replication. Import master dataset of spatial covariates and seedlings attributes sampled at stem locations.

```{r}
set.seed(123) 
darkwoods_seedlings_data <- read_excel("1.1.darkwoods_masterfile.xlsx")
darkwoods_seedlings_data %>%
  kbl
kable(darkwoods_seedlings_data, format="html") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Covariate Screening

Derive OLS models to explore covariate effects against intercept only models

```{r, fig.show='hold', out.width='33%'}
seed_formula = intensity ~ distance_m + elevation_asl + slope + 
  aspect + rix + twi + wind + mpb_grey + mpb_red + 
  fire_high + fire_med + fire_low - 1 

seed_formula2 = intensity ~ distance_m + elevation_asl + slope + 
  aspect + rix + twi + wind + mpb_class + 
  fire_high + fire_med + fire_low + fire_unbur - 1 

seed_formula3 = intensity ~ distance_m + elevation_asl + slope + 
  aspect + rix + twi + wind + mpb_grey + mpb_red + 
  fire_high + fire_med + fire_low + fire_unbur + bec_zone - 1 

seed_formula4 = intensity ~ distance_m + elevation_asl + slope + 
  aspect + rix + twi + wind + mpb_grey + mpb_red + 
  fire_high + fire_med + fire_low + fire_unbur + bec_zone + species - 1  

seed_formula5 = intensity ~ distance_m + elevation_asl + slope + 
  aspect + rix + twi + wind + mpb_grey + mpb_red + 
  fire_high + fire_med + fire_low + fire_unbur + bec_zone + species + precip - 1  

# Fitted with disturbance interaction effects with mpb-class and fire-classes combined
seed_formula6.1 = intensity ~ distance_m + elevation_asl + slope + 
  aspect + rix + twi + wind + bec_zone + species + precip + 
  mpb_class*fire_class - 1  

# Fitted with disturbance interaction effects with mpb-class and fire-classes combined
seed_formula6.2 = intensity ~ distance_m + elevation_asl + slope + 
  aspect + rix + twi + wind + bec_zone + species + precip + 
  mpb_red*fire_high + mpb_grey*fire_high + mpb_red*fire_low + mpb_grey*fire_low - 1  

allseeds_lm = lm(seed_formula, data=darkwoods_seedlings_data)
allseeds_lm2 = lm(seed_formula2, data=darkwoods_seedlings_data)
allseeds_lm3 = lm(seed_formula3, data=darkwoods_seedlings_data)
allseeds_lm4 = lm(seed_formula4, data=darkwoods_seedlings_data) #best fit model
allseeds_lm5 = lm(seed_formula5, data=darkwoods_seedlings_data)
allseeds_lm6.1 = lm(seed_formula6.1, data=darkwoods_seedlings_data)
allseeds_lm6.2 = lm(seed_formula6.2, data=darkwoods_seedlings_data)

coefplot(allseeds_lm, sort='magnitude')
coefplot(allseeds_lm2, sort='magnitude')
coefplot(allseeds_lm3, sort='magnitude')
coefplot(allseeds_lm4, sort='magnitude')
coefplot(allseeds_lm5, sort='magnitude')
coefplot(allseeds_lm6.1, sort='magnitude')
coefplot(allseeds_lm6.2, sort='magnitude')
```

## Model Training

Split into training and test data subset for each model with covariates and repsonse variables mounted.

```{r}
allseedsX_train <- build.x(allseeds_lm, data=darkwoods_seedlings_data,
                           contrasts = FALSE, sparse = TRUE)
allseedsY_train <- build.y(allseeds_lm, data=darkwoods_seedlings_data)

allseedsX_train2 <- build.x(allseeds_lm2, data=darkwoods_seedlings_data,
                           contrasts = FALSE, sparse = TRUE)
allseedsY_train2 <- build.y(allseeds_lm2, data=darkwoods_seedlings_data)

allseedsX_train3 <- build.x(allseeds_lm3, data=darkwoods_seedlings_data,
                           contrasts = FALSE, sparse = TRUE)
allseedsY_train3 <- build.y(allseeds_lm3, data=darkwoods_seedlings_data)

allseedsX_train4 <- build.x(allseeds_lm4, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train4 <- build.y(allseeds_lm4, data=darkwoods_seedlings_data)

allseedsX_train5 <- build.x(allseeds_lm5, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train5 <- build.y(allseeds_lm5, data=darkwoods_seedlings_data)

allseedsX_train6.1 <- build.x(allseeds_lm6.1, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train6.1 <- build.y(allseeds_lm6.1, data=darkwoods_seedlings_data)

allseedsX_train6.2 <- build.x(allseeds_lm6.2, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train6.2 <- build.y(allseeds_lm6.2, data=darkwoods_seedlings_data)
```

## Model Tuning

We run a generalised linear model over an elastic-net (latticed plane) using the `glmnet` package and its `glmnet` kernel to explore data with two varying lambda's; one penalizing and one performance-enhancing lambda's. Below, the `alpha=1` function is used to fit the lasso-model with a lambda that suppresses outliers. Contrastly, the `alpha=0` function fits a ridge-based lambda designed to seek out correlation. Better yet, we can apply the elastic-net function to estimate an optimal lambda as a percentage of alpha between `0` & `1`.

```{r, fig.show='hold', out.width='25%'}
allseeds_glmnet_lasso <- glmnet(x=allseedsX_train, y=allseedsY_train, family = 'gaussian', alpha = 1)
allseeds_glmnet_ridge <- glmnet(x=allseedsX_train, y=allseedsY_train, family = 'gaussian', alpha = 0)
allseeds_glmnet_lasso2 <- glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 1)
allseeds_glmnet_ridge2 <- glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 0)
allseeds_glmnet_lasso3 <- glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 1)
allseeds_glmnet_ridge3 <- glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 0)
allseeds_glmnet_lasso4 <- glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 1)
allseeds_glmnet_ridge4 <- glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 0)
allseeds_glmnet_lasso5 <- glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 1)
allseeds_glmnet_ridge5 <- glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 0)
allseeds_glmnet_lasso6.1 <- glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 1)
allseeds_glmnet_ridge6.1 <- glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 0)
allseeds_glmnet_lasso6.2 <- glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 1)
allseeds_glmnet_ridge6.2 <- glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 0)

plot(allseeds_glmnet_lasso)
plot(allseeds_glmnet_ridge)
plot(allseeds_glmnet_lasso2)
plot(allseeds_glmnet_ridge2)
plot(allseeds_glmnet_lasso3)
plot(allseeds_glmnet_ridge3)
plot(allseeds_glmnet_lasso4)
plot(allseeds_glmnet_ridge4)
plot(allseeds_glmnet_lasso5)
plot(allseeds_glmnet_ridge5)
plot(allseeds_glmnet_lasso6.1)
plot(allseeds_glmnet_ridge6.1)
plot(allseeds_glmnet_lasso6.2)
plot(allseeds_glmnet_ridge6.2)
```

## Model Validation

Adding the `nfolds` function, we apply a 10K-fold cross validation to measure the generalized and singular effects of covariates. Taken from `coefplot` package, the `coefpath` function produces an interactive graph of covariance and reduced magnitude as the model approaches a mean of zero. Zoom in to distinguish remaining predictors and their coefficients.

```{r, eval=FALSE}
allseeds_glmnet_lasso_cv_10fold <- cv.glmnet(x=allseedsX_train, y=allseedsY_train, family='gaussian', alpha=1, nfolds = 10)
allseeds_glmnet_ridge_cv_10fold <- cv.glmnet(x=allseedsX_train, y=allseedsY_train, family='gaussian', alpha=0, nfolds = 10)
allseeds_glmnet_lasso2_cv_10fold <- glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge2_cv_10fold <- glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso3_cv_10fold <- glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge3_cv_10fold <- glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso4_cv_10fold <- glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge4_cv_10fold <- glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso5_cv_10fold <- glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge5_cv_10fold <- glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso6.1_cv_10fold <- glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge6.1_cv_10fold <- glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso6.2_cv_10fold <- glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge6.2_cv_10fold <- glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 0, nfolds = 10)

plot(allseeds_glmnet_lasso_cv_10fold)
plot(allseeds_glmnet_lasso_cv_10fold)
plot(allseeds_glmnet_ridge_cv_10fold)
plot(allseeds_glmnet_lasso2_cv_10fold)
plot(allseeds_glmnet_ridge2_cv_10fold)
plot(allseeds_glmnet_lasso3_cv_10fold)
plot(allseeds_glmnet_ridge3_cv_10fold)
plot(allseeds_glmnet_lasso4_cv_10fold)
plot(allseeds_glmnet_ridge4_cv_10fold)
plot(allseeds_glmnet_lasso5_cv_10fold)
plot(allseeds_glmnet_ridge5_cv_10fold)
plot(allseeds_glmnet_lasso6.1_cv_10fold)
plot(allseeds_glmnet_ridge6.1_cv_10fold)
plot(allseeds_glmnet_lasso6.2_cv_10fold)
plot(allseeds_glmnet_ridge6.2_cv_10fold)

coefpath(allseeds_glmnet_lasso_cv_10fold)
coefpath(allseeds_glmnet_ridge_cv_10fold)
coefpath(allseeds_glmnet_lasso2_cv_10fold)
coefpath(allseeds_glmnet_ridge2_cv_10fold)
coefpath(allseeds_glmnet_lasso3_cv_10fold)
coefpath(allseeds_glmnet_ridge3_cv_10fold)
coefpath(allseeds_glmnet_lasso4_cv_10fold)
coefpath(allseeds_glmnet_ridge4_cv_10fold)
coefpath(allseeds_glmnet_lasso5_cv_10fold)
coefpath(allseeds_glmnet_ridge5_cv_10fold)
coefpath(allseeds_glmnet_lasso6.1_cv_10fold)
coefpath(allseeds_glmnet_ridge6.1_cv_10fold)
coefpath(allseeds_glmnet_lasso6.2_cv_10fold)
coefpath(allseeds_glmnet_ridge6.2_cv_10fold)
```

```{r, echo=FALSE, fig.show='hold', out.width='25%'}
allseeds_glmnet_lasso_cv_10fold <- cv.glmnet(x=allseedsX_train, y=allseedsY_train, family='gaussian', alpha=1, nfolds = 10)
allseeds_glmnet_ridge_cv_10fold <- cv.glmnet(x=allseedsX_train, y=allseedsY_train, family='gaussian', alpha=0, nfolds = 10)
allseeds_glmnet_lasso2_cv_10fold <- glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge2_cv_10fold <- glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso3_cv_10fold <- glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge3_cv_10fold <- glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso4_cv_10fold <- glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge4_cv_10fold <- glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso5_cv_10fold <- glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge5_cv_10fold <- glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso6.1_cv_10fold <- glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge6.1_cv_10fold <- glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso6.2_cv_10fold <- glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge6.2_cv_10fold <- glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 0, nfolds = 10)

plot(allseeds_glmnet_lasso_cv_10fold)
plot(allseeds_glmnet_lasso_cv_10fold)
plot(allseeds_glmnet_ridge_cv_10fold)
plot(allseeds_glmnet_lasso2_cv_10fold)
plot(allseeds_glmnet_ridge2_cv_10fold)
plot(allseeds_glmnet_lasso3_cv_10fold)
plot(allseeds_glmnet_ridge3_cv_10fold)
plot(allseeds_glmnet_lasso4_cv_10fold)
plot(allseeds_glmnet_ridge4_cv_10fold)
plot(allseeds_glmnet_lasso5_cv_10fold)
plot(allseeds_glmnet_ridge5_cv_10fold)
plot(allseeds_glmnet_lasso6.1_cv_10fold)
plot(allseeds_glmnet_ridge6.1_cv_10fold)
plot(allseeds_glmnet_lasso6.2_cv_10fold)
plot(allseeds_glmnet_ridge6.2_cv_10fold)
```

```{r, echo=FALSE, fig.show='hold', out.width='50%'}
coefpath(allseeds_glmnet_lasso_cv_10fold)
coefpath(allseeds_glmnet_lasso_cv_10fold)
coefpath(allseeds_glmnet_ridge_cv_10fold)
coefpath(allseeds_glmnet_lasso2_cv_10fold)
coefpath(allseeds_glmnet_ridge2_cv_10fold)
coefpath(allseeds_glmnet_lasso3_cv_10fold)
coefpath(allseeds_glmnet_ridge3_cv_10fold)
coefpath(allseeds_glmnet_lasso4_cv_10fold)
coefpath(allseeds_glmnet_ridge4_cv_10fold)
coefpath(allseeds_glmnet_lasso5_cv_10fold)
coefpath(allseeds_glmnet_ridge5_cv_10fold)
coefpath(allseeds_glmnet_lasso6.1_cv_10fold)
coefpath(allseeds_glmnet_ridge6.1_cv_10fold)
coefpath(allseeds_glmnet_lasso6.2_cv_10fold)
coefpath(allseeds_glmnet_ridge6.2_cv_10fold)
```
