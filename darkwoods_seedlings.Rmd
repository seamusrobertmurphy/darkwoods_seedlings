---
title: "Spatial Point Pattern Processes of Conifer Seedlings"
author: "SMurphy"
date: "2021-01-30"
output:
  github_document:
    toc: TRUE
    toc_depth: 5
    df_print: tibble
#always_allow_html: yes
---

```{r setup, include=FALSE, message = FALSE, warning=FALSE, error=FALSE}
options(htmltools.dir.version = FALSE, htmltools.preserve.raw = FALSE)
library(useful)
library(coefplot)
library(glmnet)
library(formatR)
library(readxl)
library(sf)
library(kernlab)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(useful)
library(caret)
library(tibble)
library(klaR)
library(ModelMetrics)
library(DescTools)
library(knitr)
library(magrittr)
library(flextable)
library(pandoc)
library(rmarkdown)

library(spdep)
library(gstat)
library(rgdal)
library(maptools)
library(raster)
library(spatstat)
library(sp)
library(rpanel)
library(ncf)
library(sf)
library(spatial)
library(spatstat.data)
library(spatstat.local)
library(dplyr)
library(RColorBrewer)
#install.packages("webshot")
#webshot::install_phantomjs()
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error=FALSE, comment = NA,tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

```{r, eval=FALSE, echo=FALSE}
#Note: some packages require R-version >4.3 installed
#Stage-I dependencies
requirements_I = install.packages(c(
  "readxl", "sf", "kernlab", "ggplot2", "dplyr",
  "RColorBrewer", "psych", "useful", "caret",
  "tibble", "klaR", "ModelMetrics", "DescTools",
  "MLmetrics", "coefplot", "glmnet", "jsonlite",
  "plotly", "RSQLite", "tidyverse", "useful",
  "xgboost", "webshot", "webshot2"),
  dependencies=TRUE)

#Stage-II dependencies
requirements_II = install.packages(c(
  "spdep", "gstat", "rgdal", "maptools", "raster",
  "spatstat", "GISTools", "rgeos", "sp",
  "rpanel", "ncf", "spatial", "spatstat.data",
  "spatstat.local", "dplyr", "RColorBrewer"),
  dependencies=TRUE)

requirements_I
requirements_II
```

## 1. Model Selection

### 1.1 Import Data

Seed set to `123` for replication. Import the `1.1.darkwoods_seedlings.xls` dataset. This includes seedlings and covariate values previously processed, classified and sampled from stem locations of seedlings using ArcGIS environment.

```{r, warning=FALSE, message=FALSE}
set.seed(123)
darkwoods_seedlings_data <- readxl::read_excel("1.1.darkwoods_seedlings.xls")
darkwoods_seedlings_data
#knitr::kable(head(darkwoods_seedlings_data))
```

For local deployment, package dependencies from this iteration are loaded using the `requirements_I` variable.

```{r,eval=FALSE, warning=FALSE, message=FALSE}
requirements_I = install.packages(c(
  "readxl", "sf", "kernlab", "ggplot2", "dplyr",
  "RColorBrewer", "psych", "useful", "caret",
  "tibble", "klaR", "ModelMetrics", "DescTools",
  "MLmetrics", "coefplot", "glmnet", "jsonlite",
  "plotly", "RSQLite", "tidyverse", "useful", "xgboost"),
  dependencies=TRUE)
# note warning messages are turned off for this chunk: 'warnings=FALSE'

requirements_I
```

### 1.2 Model Fitting

Derive OLS models to explore covariate effects against intercept only models. Latest iterations suggest reporting different results that whats in the current manuscript draft: model6.2 below. Thoughts?

```{r, fig.show='hold', out.width='50%', warning=FALSE, message=FALSE}
seed_formula = intensity ~ distance_m + elevation_asl + slope +
  aspect + rix + twi + wind + mpb_grey + mpb_red +
  fire_high + fire_med + fire_low - 1

seed_formula2 = intensity ~ distance_m + elevation_asl + slope +
  aspect + rix + twi + wind + mpb_class +
  fire_high + fire_med + fire_low + fire_unbur - 1

seed_formula3 = intensity ~ distance_m + elevation_asl + slope +
  aspect + rix + twi + wind + mpb_grey + mpb_red +
  fire_high + fire_med + fire_low + fire_unbur + bec_zone - 1

seed_formula4 = intensity ~ distance_m + elevation_asl + slope +
  aspect + rix + twi + wind + mpb_grey + mpb_red +
  fire_high + fire_med + fire_low + fire_unbur + bec_zone + species - 1

seed_formula5 = intensity ~ distance_m + elevation_asl + slope +
  aspect + rix + twi + wind + mpb_grey + mpb_red +
  fire_high + fire_med + fire_low + fire_unbur + bec_zone + species + precip - 1

# Fitted with disturbance interaction effects by mpb-class and fire-classes combined
seed_formula6.1 = intensity ~ distance_m + elevation_asl + slope +
  aspect + rix + twi + wind + bec_zone + species + precip +
  mpb_class*fire_class - 1

# Fitted with disturbance interaction effects by mpb-class and fire-classes combined
seed_formula6.2 = intensity ~ distance_m + elevation_asl + slope +
  aspect + rix + twi + wind + bec_zone + species + precip +
  mpb_red*fire_high + mpb_grey*fire_high + mpb_red*fire_low + mpb_grey*fire_low - 1

allseeds_lm = lm(seed_formula, data=darkwoods_seedlings_data)
allseeds_lm2 = lm(seed_formula2, data=darkwoods_seedlings_data)
allseeds_lm3 = lm(seed_formula3, data=darkwoods_seedlings_data)
allseeds_lm4 = lm(seed_formula4, data=darkwoods_seedlings_data)
allseeds_lm5 = lm(seed_formula5, data=darkwoods_seedlings_data)
allseeds_lm6.1 = lm(seed_formula6.1, data=darkwoods_seedlings_data)
allseeds_lm6.2 = lm(seed_formula6.2, data=darkwoods_seedlings_data)

coefplot::coefplot(allseeds_lm, sort='magnitude')
coefplot::coefplot(allseeds_lm2, sort='magnitude')
coefplot::coefplot(allseeds_lm3, sort='magnitude')
coefplot::coefplot(allseeds_lm4, sort='magnitude')
coefplot::coefplot(allseeds_lm5, sort='magnitude')
coefplot::coefplot(allseeds_lm6.1, sort='magnitude')
coefplot::coefplot(allseeds_lm6.2, sort='magnitude') #this seems the most interesting model
```

### 1.3 Model Training

Split into training and test data subset for each model with covariates and repsonse variables mounted.

```{r, warning=FALSE, message=FALSE}
allseedsX_train <- useful::build.x(allseeds_lm, data=darkwoods_seedlings_data,
                           contrasts = FALSE, sparse = TRUE)
allseedsY_train <- useful::build.y(allseeds_lm, data=darkwoods_seedlings_data)

allseedsX_train2 <- useful::build.x(allseeds_lm2, data=darkwoods_seedlings_data,
                           contrasts = FALSE, sparse = TRUE)
allseedsY_train2 <- useful::build.y(allseeds_lm2, data=darkwoods_seedlings_data)

allseedsX_train3 <- useful::build.x(allseeds_lm3, data=darkwoods_seedlings_data,
                           contrasts = FALSE, sparse = TRUE)
allseedsY_train3 <- useful::build.y(allseeds_lm3, data=darkwoods_seedlings_data)

allseedsX_train4 <- useful::build.x(allseeds_lm4, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train4 <- useful::build.y(allseeds_lm4, data=darkwoods_seedlings_data)

allseedsX_train5 <- useful::build.x(allseeds_lm5, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train5 <- useful::build.y(allseeds_lm5, data=darkwoods_seedlings_data)

allseedsX_train6.1 <- useful::build.x(allseeds_lm6.1, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train6.1 <- useful::build.y(allseeds_lm6.1, data=darkwoods_seedlings_data)

allseedsX_train6.2 <- useful::build.x(allseeds_lm6.2, data=darkwoods_seedlings_data,
                            contrasts = FALSE, sparse = TRUE)
allseedsY_train6.2 <- useful::build.y(allseeds_lm6.2, data=darkwoods_seedlings_data)
```

### 1.4 Model Tuning

From the `glmnet` package, covariates are fitted to a generalised linear model over an elastic-net (latticed plane) in order to explore their effects under varying lambdas. The `alpha=1` function is used to fit a lasso-model with a lambda that suppresses outliers, and the `alpha=0` function fits a ridge-based lambda to empower correlation. Adding the `nfolds` function, we apply a 10K-fold cross validation and then compare coeffients visually using the `coefpath` function from the `coefplot` package. Zoom in on graphs to determine the remaining predictors as the model approaches a mean of zero. Most interesting model seems to 6.1.

```{r, warning=FALSE, message=FALSE}
allseeds_glmnet_lasso_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train, y=allseedsY_train, family='gaussian', alpha=1, nfolds = 10)
allseeds_glmnet_ridge_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train, y=allseedsY_train, family='gaussian', alpha=0, nfolds = 10)
allseeds_glmnet_lasso2_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge2_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train2, y=allseedsY_train2, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso3_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge3_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train3, y=allseedsY_train3, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso4_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge4_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train4, y=allseedsY_train4, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso5_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge5_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train5, y=allseedsY_train5, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso6.1_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge6.1_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train6.1, y=allseedsY_train6.1, family = 'gaussian', alpha = 0, nfolds = 10)
allseeds_glmnet_lasso6.2_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 1, nfolds = 10)
allseeds_glmnet_ridge6.2_cv_10fold <- glmnet::cv.glmnet(x=allseedsX_train6.2, y=allseedsY_train6.2, family = 'gaussian', alpha = 0, nfolds = 10)

plot(allseeds_glmnet_lasso6.2_cv_10fold)
coefplot::coefpath(allseeds_glmnet_lasso6.2_cv_10fold)
plot(allseeds_glmnet_ridge6.2_cv_10fold)
coefplot::coefpath(allseeds_glmnet_ridge6.2_cv_10fold)
```

## 2. Spatial Point Patterns

### 2.1 Import Data

In the following, we use three separate datasets; one which is already loaded, the main seedlings dataset above, and two more imported as excel and raster files and renamed below. Separate datasets of specific formats are required by the `spatstat` package depending on spatial modelling operations, including conversion of covariates into `.img` image files in the code chunk after this.

1.  `darkwoods_seedlings_data` - already loaded excel file from above,
2.  `darkwoods_seedlings_tree_distance` - excel file showing seed-distance,
3.  Rasters x 11 showing terrain, climate, and disturbance covariates.

Package requirements for stage-II listed below.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
requirements_II = install.packages(c("spdep", "gstat", "rgdal", "maptools", "raster",
                                  "spatstat", "GISTools", "rgeos", "sp",
                                  "rpanel", "ncf", "spatial", "spatstat.data",
                                  "spatstat.local", "dplyr", "RColorBrewer", "jsonlite",
                                  "plotly", "RSQLite", "tidyverse", "useful", "xgboost"), dependencies=TRUE)
requirements_II # settings on 'warnings=FALSE'
```

```{r, warning=FALSE, message=FALSE}
darkwoods_seedlings_tree_distance = read_excel("1.2.darkwoods_seedlings_distance.xls")
darkwoods_seedlings_tree_distance
#knitr::kable(head(darkwoods_seedlings_tree_distance))

elevation_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/elevation_utm.tif"))
aspect_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/aspect_utm_bear.tif"))
slope_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/slope_utm.tif"))
rix_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/rix_utm.tif"))
twi_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/twi_utm.tif"))
wind_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/wind_utm.tif"))
mpb_grey_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/mpb_grey_na.tif"))
mpb_red_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/mpb_red_na.tif"))
fire_high_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/fire_high_na.tif"))
fire_med_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/fire_med_na.tif"))
fire_low_utm = readAll(raster("~/Desktop/git_repos/darkwoods_seedlings/SpatialData/fire_low_na.tif"))
```

### 2.2 Tidy Data

Convert datasets of seedlings and seed-distance from `sf` simple feature objects, to `sp` spatial objects, to `ppp` point pattern process objects. This is the required conversion flow for `ppp` objects. Then convert covariate rasters and seed-distance from `ppp` objects to `.img` image objects. Make sure to complete all transformations and data cleaning at the 'sf' stage.

The `crsProject` variable sets projections to `EPSG:32611`. Question, is it better practice to reproject everything to the LiDAR's *original* coordinate system than to reproject everything to Landsat's *official* projection? Although our higher-resolution LiDAR is superior in terms of georeferencing accuracy, most important predictors are Landsat-derived. Additionally, field equipment was calibrated to `EPSG:3005`.

```{r, warning=FALSE, message=FALSE}
# Project crs projection
crsProject = st_crs("EPSG:32611")
# Convert to sf
seedlings_allplots_sf = st_as_sf(darkwoods_seedlings_data,
                                 coords = c("x", "y"),
                                 crs = crsProject)

distance_tree = st_as_sf(darkwoods_seedlings_tree_distance,
                         coords = c("x", "y"),
                         crs = crsProject)

# Factorise and relabel
seedlings_allplots_sf$plot1 = factor(seedlings_allplots_sf$plot1)
seedlings_allplots_sf$plot2 = factor(seedlings_allplots_sf$plot2)
seedlings_allplots_sf$plot3 = factor(seedlings_allplots_sf$plot3)
seedlings_allplots_sf$plot123 = factor(seedlings_allplots_sf$plot123)
seedlings_allplots_sf$bec_zone = factor(seedlings_allplots_sf$bec_zone)
seedlings_allplots_sf$species <- factor(seedlings_allplots_sf$species,
                                              levels = c(0,1,2,3,4,5,7),
                                              labels = c("Larix occidentalis",
                                              "Pseudostuga menzeisii",
                                              "Picea endelmannii",
                                              "Pinus contorta",
                                              "Pinus ponderosa",
                                              "Pinus monticola",
                                              "Tsuga heterophylla"))

# Convert sf to sp to ppp pbjects
seedlings_allplots_sp = as(seedlings_allplots_sf, "Spatial")
seedlings_allplots_ppp = as(seedlings_allplots_sp, "ppp")

distance_tree_sp = as(distance_tree, "Spatial")
distance_tree_ppp = as(distance_tree_sp, "ppp")
distance_tree_im = as.im.ppp(distance_tree_ppp)

elevation_im = as.im(elevation_utm)
aspect_im = as.im.RasterLayer(aspect_utm)
slope_im = as.im.RasterLayer(slope_utm)
rix_im = as.im.RasterLayer(rix_utm)
twi_im = as.im.RasterLayer(twi_utm)
wind_im = as.im.RasterLayer(wind_utm)
mpb_grey_im = as.im.RasterLayer(mpb_grey_utm)
mpb_red_im = as.im.RasterLayer(mpb_red_utm)
fire_high_im = as.im.RasterLayer(fire_high_utm)
fire_med_im = as.im.RasterLayer(fire_med_utm)
fire_low_im = as.im.RasterLayer(fire_low_utm)
```

Subset seedlings by plot and by species at the `sp` and `ppp` stages to enable plotting and model fitting. For global analysis, plot subsamples are pooled using ratio-estimation function: `superimpose`

```{r, message=FALSE, warning=FALSE}
seedlings_plot1_sp = subset(seedlings_allplots_sp,plot1==1)
seedlings_plot2_sp = subset(seedlings_allplots_sp,plot2==1)
seedlings_plot3_sp = subset(seedlings_allplots_sp,plot3==1)
seedlings_plot1_ppp = subset(seedlings_allplots_ppp,plot1==1)
seedlings_plot2_ppp = subset(seedlings_allplots_ppp,plot2==1)
seedlings_plot3_ppp = subset(seedlings_allplots_ppp,plot3==1)

larix_spp_allplots_sf = subset(seedlings_allplots_sf,larix_spp==1)
pseudo_m_allplots_sf = subset(seedlings_allplots_sf, pseudo_m==1)
picea_eng_allplots_sf = subset(seedlings_allplots_sf, picea_eng==1)
pinus_con_allplots_sf = subset(seedlings_allplots_sf, pinus_con==1)
pinus_pond_allplots_sf = subset(seedlings_allplots_sf, pinus_pond==1)
pinus_monti_allplots_sf = subset(seedlings_allplots_sf, pinus_albi==1)
tsuga_hete_allplots_sf = subset(seedlings_allplots_sf, tsuga_hete==1)
larix_spp_allplots_sp = subset(seedlings_allplots_sp,larix_spp==1)
pseudo_m_allplots_sp = subset(seedlings_allplots_sp, pseudo_m==1)
picea_eng_allplots_sp = subset(seedlings_allplots_sp, picea_eng==1)
pinus_con_allplots_sp = subset(seedlings_allplots_sp, pinus_con==1)
pinus_pond_allplots_sp = subset(seedlings_allplots_sp, pinus_pond==1)
pinus_monti_allplots_sp = subset(seedlings_allplots_sp, pinus_albi==1)
tsuga_hete_allplots_sp = subset(seedlings_allplots_sp, tsuga_hete==1)
larix_spp_allplots_ppp = subset(seedlings_allplots_ppp,larix_spp==1)
pseudo_m_allplots_ppp = subset(seedlings_allplots_ppp, pseudo_m==1)
picea_eng_allplots_ppp = subset(seedlings_allplots_ppp, picea_eng==1)
pinus_con_allplots_ppp = subset(seedlings_allplots_ppp, pinus_con==1)
pinus_pond_allplots_ppp = subset(seedlings_allplots_ppp, pinus_pond==1)
pinus_monti_allplots_ppp = subset(seedlings_allplots_ppp, pinus_albi==1)
tsuga_hete_allplots_ppp = subset(seedlings_allplots_ppp, tsuga_hete==1)

# Plot 1 by species
larix_spp_plot1_sp = subset(seedlings_plot1_sp, larix_spp==1)
pseudo_m_plot1_sp = subset(seedlings_plot1_sp, pseudo_m==1)
picea_eng_plot1_sp = subset(seedlings_plot1_sp, picea_eng==1)
pinus_con_plot1_sp = subset(seedlings_plot1_sp, pinus_con==1)
pinus_pond_plot1_sp = subset(seedlings_plot1_sp, pinus_pond==1)
pinus_monti_plot1_sp = subset(seedlings_plot1_sp, pinus_albi==1)
tsuga_hete_plot1_sp = subset(seedlings_plot1_sp, tsuga_hete==1)
larix_spp_plot1_ppp = subset(seedlings_plot1_ppp, larix_spp==1)
pseudo_m_plot1_ppp = subset(seedlings_plot1_ppp, pseudo_m==1)
picea_eng_plot1_ppp = subset(seedlings_plot1_ppp, picea_eng==1)
pinus_con_plot1_ppp = subset(seedlings_plot1_ppp, pinus_con==1)
pinus_pond_plot1_ppp = subset(seedlings_plot1_ppp, pinus_pond==1)
pinus_monti_plot1_ppp = subset(seedlings_plot1_ppp, pinus_albi==1)
tsuga_hete_plot1_ppp = subset(seedlings_plot1_ppp, tsuga_hete==1)

# Plot 2 by species
larix_spp_plot2_sp = subset(seedlings_plot2_sp, larix_spp==1)
pseudo_m_plot2_sp = subset(seedlings_plot2_sp, pseudo_m==1)
picea_eng_plot2_sp = subset(seedlings_plot2_sp, picea_eng==1)
pinus_con_plot2_sp = subset(seedlings_plot2_sp, pinus_con==1)
pinus_pond_plot2_sp = subset(seedlings_plot2_sp, pinus_pond==1)
pinus_monti_plot2_sp = subset(seedlings_plot2_sp, pinus_albi==1)
tsuga_hete_plot2_sp = subset(seedlings_plot2_sp, tsuga_hete==1)
larix_spp_plot2_ppp = subset(seedlings_plot2_ppp, larix_spp==1)
pseudo_m_plot2_ppp = subset(seedlings_plot2_ppp, pseudo_m==1)
picea_eng_plot2_ppp = subset(seedlings_plot2_ppp, picea_eng==1)
pinus_con_plot2_ppp = subset(seedlings_plot2_ppp, pinus_con==1)
pinus_pond_plot2_ppp = subset(seedlings_plot2_ppp, pinus_pond==1)
pinus_monti_plot2_ppp = subset(seedlings_plot2_ppp, pinus_albi==1)
tsuga_hete_plot2_ppp = subset(seedlings_plot2_ppp, tsuga_hete==1)

# Plot 3 by species
larix_spp_plot3_sp = subset(seedlings_plot3_sp, larix_spp==1)
pseudo_m_plot3_sp = subset(seedlings_plot3_sp, pseudo_m==1)
picea_eng_plot3_sp = subset(seedlings_plot3_sp, picea_eng==1)
pinus_con_plot3_sp = subset(seedlings_plot3_sp, pinus_con==1)
pinus_pond_plot3_sp = subset(seedlings_plot3_sp, pinus_pond==1)
pinus_monti_plot3_sp = subset(seedlings_plot3_sp, pinus_albi==1)
tsuga_hete_plot3_sp = subset(seedlings_plot3_sp, tsuga_hete==1)
larix_spp_plot3_ppp = subset(seedlings_plot3_ppp, larix_spp==1)
pseudo_m_plot3_ppp = subset(seedlings_plot3_ppp, pseudo_m==1)
picea_eng_plot3_ppp = subset(seedlings_plot3_ppp, picea_eng==1)
pinus_con_plot3_ppp = subset(seedlings_plot3_ppp, pinus_con==1)
pinus_pond_plot3_ppp = subset(seedlings_plot3_ppp, pinus_pond==1)
pinus_monti_plot3_ppp = subset(seedlings_plot3_ppp, pinus_albi==1)
tsuga_hete_plot3_ppp = subset(seedlings_plot3_ppp, tsuga_hete==1)

# All plots by species pooled by ratio-estimation
seedlings_pooled = superimpose(seedlings_plot1_ppp, seedlings_plot2_ppp , seedlings_plot3_ppp)
pinus_con_pooled = superimpose(pinus_con_plot1_ppp, pinus_con_plot2_ppp, pinus_con_plot3_ppp)
larix_spp_pooled = superimpose(larix_spp_plot1_ppp, larix_spp_plot2_ppp, larix_spp_plot3_ppp)
picea_eng_pooled = superimpose(picea_eng_plot1_ppp, picea_eng_plot2_ppp, picea_eng_plot3_ppp)
pseudo_m_pooled = superimpose(pseudo_m_plot1_ppp, pseudo_m_plot2_ppp, pseudo_m_plot3_ppp)
pinus_pond_pooled = superimpose(pinus_pond_plot1_ppp, pinus_pond_plot2_ppp, pinus_pond_plot3_ppp)
pinus_monti_pooled = superimpose(pinus_monti_plot1_ppp, pinus_monti_plot2_ppp, pinus_monti_plot1_ppp)
tsuga_hete_pooled = superimpose(tsuga_hete_plot1_ppp, tsuga_hete_plot2_ppp, tsuga_hete_plot3_ppp)
```

Import and tidy shapefiles of seedling plot boundaries to derive and assign observational windows to point pattern objects. Depending on `spatstat` operation, `ppp` objects must be marked or unmarked using the `marks` function, see bottom of chunk below.

```{r, warning=FALSE, message=FALSE}
mask_plot1 = readOGR(dsn = "~/Desktop/git_repos/darkwoods_seedlings/plots123.shps/", layer="plot1X", verbose = FALSE)
mask_plot2 = readOGR(dsn = "~/Desktop/git_repos/darkwoods_seedlings/plots123.shps/", layer="plot2X", verbose = FALSE)
mask_plot3 = readOGR(dsn = "~/Desktop/git_repos/darkwoods_seedlings/plots123.shps/", layer="plot3X", verbose = FALSE)
mask_allplots = readOGR(dsn = "~/Desktop/git_repos/darkwoods_seedlings/plots123.shps/", layer="plots123", verbose = FALSE)

#check OR assign coordinate reference systems
#crs(mask_plot1)
#crs(mask_plot2)
#crs(mask_plot3)
#crs(mask_allplots)

#crs(mask_plot1) <- "+proj=utm +zone=11 +datum=WGS84 +units=m +no_defs"
#crs(mask_plot2) <- "+proj=utm +zone=11 +datum=WGS84 +units=m +no_defs"
#crs(mask_plot3) <- "+proj=utm +zone=11 +datum=WGS84 +units=m +no_defs"
#crs(mask_allplots) <- "+proj=utm +zone=11 +datum=WGS84 +units=m +no_defs"

#derive observational windows
win_plot1 = as.owin(mask_plot1, unitname="meters")
win_plot2 = as.owin(mask_plot2, unitname="meters")
win_plot3 = as.owin(mask_plot3, unitname="meters")
win_allplots = as.owin(mask_allplots, unitname="meters")

#assign observational windows
Window(seedlings_plot1_ppp)=win_plot1
Window(seedlings_plot2_ppp)=win_plot2
Window(seedlings_plot3_ppp)=win_plot3
Window(seedlings_allplots_ppp)=win_allplots

Window(larix_spp_allplots_ppp)=win_allplots
Window(pseudo_m_allplots_ppp)=win_allplots
Window(picea_eng_allplots_ppp)=win_allplots
Window(pinus_con_allplots_ppp)=win_allplots
Window(pinus_pond_allplots_ppp)=win_allplots
Window(pinus_monti_allplots_ppp)=win_allplots
Window(tsuga_hete_allplots_ppp)=win_allplots

Window(larix_spp_plot1_ppp)=win_plot1
Window(pseudo_m_plot1_ppp)=win_plot1
Window(picea_eng_plot1_ppp)=win_plot1
Window(pinus_con_plot1_ppp)=win_plot1
Window(pinus_pond_plot1_ppp)=win_plot1
Window(pinus_monti_plot1_ppp)=win_plot1
Window(tsuga_hete_plot1_ppp)=win_plot1

Window(larix_spp_plot2_ppp)=win_plot2
Window(pseudo_m_plot2_ppp)=win_plot2
Window(picea_eng_plot2_ppp)=win_plot2
Window(pinus_con_plot2_ppp)=win_plot2
Window(pinus_pond_plot2_ppp)=win_plot2
Window(pinus_monti_plot2_ppp)=win_plot2
Window(tsuga_hete_plot2_ppp)=win_plot2

Window(larix_spp_plot3_ppp)=win_plot3
Window(pseudo_m_plot3_ppp)=win_plot3
Window(picea_eng_plot3_ppp)=win_plot3
Window(pinus_con_plot3_ppp)=win_plot3
Window(pinus_pond_plot3_ppp)=win_plot3
Window(pinus_monti_plot3_ppp)=win_plot3
Window(tsuga_hete_plot3_ppp)=win_plot3

#assign unit of division is set to meters
unitname(larix_spp_allplots_ppp)=c("meter", "meter")
unitname(pseudo_m_allplots_ppp)=c("meter", "meter")
unitname(picea_eng_allplots_ppp)=c("meter", "meter")
unitname(pinus_con_allplots_ppp)=c("meter", "meter")
unitname(pinus_pond_allplots_ppp)=c("meter", "meter")
unitname(pinus_monti_allplots_ppp)=c("meter", "meter")
unitname(tsuga_hete_allplots_ppp)=c("meter", "meter")

unitname(larix_spp_plot1_ppp)=c("meter", "meter")
unitname(pseudo_m_plot1_ppp)=c("meter", "meter")
unitname(picea_eng_plot1_ppp)=c("meter", "meter")
unitname(pinus_con_plot1_ppp)=c("meter", "meter")
unitname(pinus_pond_plot1_ppp)=c("meter", "meter")
unitname(pinus_monti_plot1_ppp)=c("meter", "meter")
unitname(tsuga_hete_plot1_ppp)=c("meter", "meter")

unitname(larix_spp_plot2_ppp)=c("meter", "meter")
unitname(pseudo_m_plot2_ppp)=c("meter", "meter")
unitname(picea_eng_plot2_ppp)=c("meter", "meter")
unitname(pinus_con_plot2_ppp)=c("meter", "meter")
unitname(pinus_pond_plot2_ppp)=c("meter", "meter")
unitname(pinus_monti_plot2_ppp)=c("meter", "meter")
unitname(tsuga_hete_plot2_ppp)=c("meter", "meter")

unitname(larix_spp_plot3_ppp)=c("meter", "meter")
unitname(pseudo_m_plot3_ppp)=c("meter", "meter")
unitname(picea_eng_plot3_ppp)=c("meter", "meter")
unitname(pinus_con_plot3_ppp)=c("meter", "meter")
unitname(pinus_pond_plot3_ppp)=c("meter", "meter")
unitname(pinus_monti_plot3_ppp)=c("meter", "meter")
unitname(tsuga_hete_plot3_ppp)=c("meter", "meter")

marks(seedlings_plot1_ppp) <- seedlings_plot1_ppp$species
marks(seedlings_plot2_ppp) <- seedlings_plot2_ppp$species
marks(seedlings_plot3_ppp) <- seedlings_plot3_ppp$species
marks(seedlings_allplots_ppp) <- seedlings_allplots_ppp$species
```

### 2.3 Seedling Sample Plots

```{r, warning=FALSE, message=FALSE}
plot(seedlings_plot1_ppp, type="n", main="Plot 1 seedlings")
points(pinus_con_plot1_ppp,pch=20,cex=0.8,col="yellow")
points(larix_spp_plot1_ppp,pch=20,cex=0.8,col="green3")
points(pseudo_m_plot1_ppp,pch=20,cex=0.8,col="brown")
points(picea_eng_plot1_ppp,pch=20,cex=0.8,col="purple")
points(pinus_pond_plot1_ppp,pch=20,cex=0.8,col="red")
points(pinus_monti_plot1_ppp,pch=20,cex=0.8,col="black")
points(tsuga_hete_plot1_ppp,pch=20,cex=0.8,col="blue")
species_palette = c("yellow", "green3", "brown", "purple","red", "black", "cyan", "blue")
legend("topright",legend=levels(seedlings_allplots_sp$species), fill=species_palette)

plot(seedlings_plot2_ppp, type="n", main="Plot 2 seedlings")
points(pinus_con_plot2_ppp,pch=20,cex=0.8,col="yellow")
points(larix_spp_plot2_ppp,pch=20,cex=0.8,col="green3")
points(pseudo_m_plot2_ppp,pch=20,cex=0.8,col="brown")
points(picea_eng_plot2_ppp,pch=20,cex=0.8,col="purple")
points(pinus_pond_plot2_ppp,pch=20,cex=0.8,col="red")
points(pinus_monti_plot2_ppp,pch=20,cex=0.8,col="black")
points(tsuga_hete_plot2_ppp,pch=20,cex=0.8,col="blue")

plot(seedlings_plot3_ppp, type="n", main="Plot 3 seedlings")
points(pinus_con_plot3_ppp,pch=20,cex=0.8,col="yellow")
points(larix_spp_plot3_ppp,pch=20,cex=0.8,col="green3")
points(pseudo_m_plot3_ppp,pch=20,cex=0.8,col="brown")
points(picea_eng_plot3_ppp,pch=20,cex=0.8,col="purple")
points(pinus_pond_plot3_ppp,pch=20,cex=0.8,col="red")
points(pinus_monti_plot3_ppp,pch=20,cex=0.8,col="black")
points(tsuga_hete_plot3_ppp,pch=20,cex=0.8,col="blue")
```

### 2.4 Seedling Heat Maps

Seedling density patterns were mapped using the `epanechnikov` kernel density estimator and heat maps. The `epanechnikov` was chosen over `Gaussian` and `Nadaraya-Watson` kernels to address non-constant intensity as it handles negative outliers more conservatively and still provides MSE rather than MISE metrics. Diggle default bandwidth settings applied

```{r, fig.show='hold', out.width='50%', warning=FALSE, message=FALSE}
#plot 1 - all species pooled - bandwidth=10
marks(seedlings_plot1_ppp) = NULL
density_plot1 = density(seedlings_plot1_ppp,
                        sigma=10,
                        kernel="epanechnikov",
                        diggle=TRUE)

plot(density_plot1, main="Plot 1", las=1)
contour(density_plot1, add=TRUE)
persp(density_plot1, main="Plot 1")

#kernel density of plot 2 all seedlings
marks(seedlings_plot2_ppp) = NULL
density_plot2 = density(seedlings_plot2_ppp,
                        sigma=10,
                        kernel="epanechnikov",
                        diggle=TRUE)

plot(density_plot2, main="Plot 2", las=1)
contour(density_plot2, add=TRUE)
persp(density_plot2, main="Plot 2")

#kernel density of plot 3 all seedlings
marks(seedlings_plot3_ppp) = NULL
density_plot3 = density(seedlings_plot3_ppp,
                        sigma=10,
                        kernel="epanechnikov",
                        diggle=TRUE)

plot(density_plot3, main="Plot 3", las=1)
contour(density_plot3, add=TRUE)
persp(density_plot3, main="Plot 3")
#style command for perspective plots
#persp(D, theta=70, phi=25, shade=0.4)
```

### 2.5 Seedling Nearest-Neighbour Analysis

To confirm spatial patterns in seeding density, we first test using nearest-neighbour algorithms: `nndist`. This is applied across plots and by species.

```{r, warning=FALSE, message=FALSE}
#compute nearest neighbour distance between plots
ann_seedlings_allplots <- nndist.ppp(seedlings_allplots_ppp, k=1)
ann_seedlings_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_seedlings_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_seedlings_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))
kruskal.test(ann_seedlings_allplots ~ plot123, data = seedlings_allplots_sf) #significant: p<0.0001

ann_seedlings_allplots_metrics = psych::describe(ann_seedlings_allplots)
ann_seedlings_plot1_metrics = psych::describe(ann_seedlings_plot1)
ann_seedlings_plot2_metrics = psych::describe(ann_seedlings_plot2)
ann_seedlings_plot3_metrics = psych::describe(ann_seedlings_plot3)
ann_seedlings_allplots_metrics
ann_seedlings_plot1_metrics
ann_seedlings_plot2_metrics
ann_seedlings_plot3_metrics

#compute nearest neighbour distance by species within plots
ann_larix_spp_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_pseudo_m_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_picea_eng_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_pinus_con_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_pinus_pond_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_pinus_monti_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_tsuga_hete_plot1 <- mean(nndist(seedlings_plot1_ppp, k=1))
ann_larix_spp_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_pseudo_m_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_picea_eng_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_pinus_con_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_pinus_pond_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_pinus_monti_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_tsuga_hete_plot2 <- mean(nndist(seedlings_plot2_ppp, k=1))
ann_larix_spp_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))
ann_pseudo_m_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))
ann_picea_eng_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))
ann_pinus_con_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))
ann_pinus_pond_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))
ann_pinus_monti_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))
ann_tsuga_hete_plot3 <- mean(nndist(seedlings_plot3_ppp, k=1))

ann_larix_spp_plot1_metrics = psych::describe(ann_larix_spp_plot1)
ann_pseudo_m_plot1_metrics = psych::describe(ann_pseudo_m_plot1)
ann_picea_eng_plot1_metrics = psych::describe(ann_picea_eng_plot1)
ann_pinus_con_plot1_metrics = psych::describe(ann_pinus_con_plot1)
ann_pinus_pond_plot1_metrics = psych::describe(ann_pinus_pond_plot1)
ann_pinus_monti_plot1_metrics = psych::describe(ann_pinus_monti_plot1)
ann_tsuga_hete_plot1_metrics = psych::describe(ann_tsuga_hete_plot1)
ann_larix_spp_plot2_metrics = psych::describe(ann_larix_spp_plot2)
ann_pseudo_m_plot2_metrics = psych::describe(ann_pseudo_m_plot2)
ann_picea_eng_plot2_metrics = psych::describe(ann_picea_eng_plot2)
ann_pinus_con_plot2_metrics = psych::describe(ann_pinus_con_plot2)
ann_pinus_pond_plot2_metrics = psych::describe(ann_pinus_pond_plot2)
ann_pinus_monti_plot2_metrics = psych::describe(ann_pinus_monti_plot2)
ann_tsuga_hete_plot2_metrics = psych::describe(ann_tsuga_hete_plot2)
ann_larix_spp_plot3_metrics = psych::describe(ann_larix_spp_plot3)
ann_pseudo_m_plot3_metrics = psych::describe(ann_pseudo_m_plot3)
ann_picea_eng_plot3_metrics = psych::describe(ann_picea_eng_plot3)
ann_pinus_con_plot3_metrics = psych::describe(ann_pinus_con_plot3)
ann_pinus_pond_plot3_metrics = psych::describe(ann_pinus_pond_plot3)
ann_pinus_monti_plot3_metrics = psych::describe(ann_pinus_monti_plot3)
ann_tsuga_hete_plot3_metrics = psych::describe(ann_tsuga_hete_plot3)

ann_larix_spp_plot1_metrics
ann_larix_spp_plot2_metrics
ann_larix_spp_plot3_metrics

ann_pseudo_m_plot1_metrics
ann_pseudo_m_plot2_metrics
ann_pseudo_m_plot3_metrics

ann_picea_eng_plot1_metrics
ann_picea_eng_plot2_metrics
ann_picea_eng_plot3_metrics

ann_pinus_con_plot1_metrics
ann_pinus_con_plot2_metrics
ann_pinus_con_plot3_metrics

ann_pinus_pond_plot1_metrics
ann_pinus_pond_plot2_metrics
ann_pinus_pond_plot3_metrics

ann_pinus_monti_plot1_metrics
ann_pinus_monti_plot2_metrics
ann_pinus_monti_plot3_metrics

ann_tsuga_hete_plot1_metrics
ann_tsuga_hete_plot2_metrics
ann_tsuga_hete_plot3_metrics
```

### 2.6 Seedling Descriptives

The following commands derive descriptive statistics used to populate tables 2.1 and 2.2 in manuscript draft, as shown directly.

|           |               |              |                |              |               |             |
|-----------|-----------|-----------|-----------|-----------|-----------|-----------|
|           | **Elevation** | **Slope**    | **RIX**        | **Aspect**   | **TWI**       | **Wind**    |
| Pooled    | 1516 (224.2)  | 13.81(7.96)  | 0.51 (0.06)    | 91.5 (58.2)  | 5.03 (1.27)   | 4.88 (0.79) |
| Plot 1    | 1769 (14.1)   | 7.82 (4.99)  | 0.55 (0.07)    | 144.0(79.2)  | 5.19 (0.61)   | 5.75 (0.12) |
| Plot 2    | 1672 (12.7)   | 7.56 (1.47)  | 0.48 (0.05)    | 99.2 (29.9)  | 4.78 (1.28)   | 5.32 (0.09) |
| Plot 3    | 1251 (37.8)   | 22.5 (2.72)  | 0.50 (0.03)    | 51.7 (10.5)  | 5.13 (1.53)   | 3.97 (0.13) |
|           |               |              |                |              |               |             |
| Pinus c.  | 1516 (224.5)  | 13.70 (8.97) | 0.51 (0.060)   | 91.4 (57.6)  | 5.04 (1.28)   | 4.88 (0.79) |
| Larix o.  | 1511 (226.7)  | 13.55 (8.21) | 0.508 (0.060)  | 93.9 (64.3)  | 4.942 (1.288) | 4.86 (0.80) |
| Picea e.  | 1509 (225.1)  | 13.83 (8.20) | 0.507 (0.062)  | 91.0 (56.8)  | 5.076 (1.278) | 4.87 (0.78) |
| Pseudo m. | 1510 (222.3)  | 14.20 (7.70) | 0.505 (0.057)  | 86.3 (48.4)  | 4.890 (1.370) | 4.85 (0.77) |
| Pinus p.  | 1406 (208.2)  | 16.93 (7.46) | 0.491 (0.043)  | 68.6 (26.7)  | 4.996 (1.343) | 4.47 (0.68) |
| Pinus m.  | 1709 (291.1)  | 10.15 (5.48) | 0.539 (0.060)  | 156.6(100.8) | 5.121 (0.773) | 5.59 (0.34) |
| Tsuga h.  | 1475 (218.0)  | 13.89 (7.79) | 0.504 (0.046)  | 77.4 (28.0)  | 5.001 (0.991) | 4.89 (0.77) |

|           |              |              |             |               |              |              |               |            |            |             |
|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|
|           | **MPB-free** | **MPB-grey** | **MPB-red** | **Fire-free** | **Fire-low** | **Fire-med** | **Fire-high** | **ICHdw1** | **ICHmw4** | **ESSFmw4** |
| Pooled    | 0.72         | 0.04         | 0.25        | 0.06          | 0.38         | 0.44         | 0.13          | 0.06       | 0.35       | 0.59        |
| Plot 1    | 0.55         | 0.12         | 0.33        | 0.00          | 0.40         | 0.44         | 0.16          | 0.00       | 0.00       | 1.00        |
| Plot 2    | 0.49         | 0.02         | 0.49        | 0.15          | 0.19         | 0.56         | 0.10          | 0.00       | 0.00       | 1.00        |
| Plot 3    | 1.00         | 0.00         | 0.00        | 0.02          | 0.51         | 0.34         | 0.13          | 0.15       | 0.85       | 0.00        |
|           |              |              |             |               |              |              |               |            |            |             |
| Pinus c.  | 0.72         | 0.04         | 0.24        | 0.06          | 0.37         | 0.43         | 0.13          | 0.06       | 0.35       | 0.59        |
| Larix o.  | 0.69         | 0.05         | 0.26        | 0.05          | 0.36         | 0.43         | 0.15          | 0.07       | 0.35       | 0.58        |
| Picea e.  | 0.66         | 0.04         | 0.30        | 0.04          | 0.40         | 0.45         | 0.11          | 0.04       | 0.38       | 0.58        |
| Pseudo m. | 0.74         | 0.03         | 0.23        | 0.02          | 0.42         | 0.46         | 0.09          | 0.08       | 0.34       | 0.58        |
| Pinus p.  | 0.79         | 0.02         | 0.19        | 0.04          | 0.42         | 0.47         | 0.07          | 0.13       | 0.49       | 0.38        |
| Pinus a.  | 0.63         | 0.04         | 0.33        | 0.02          | 0.42         | 0.37         | 0.19          | 0.00       | 0.04       | 0.96        |
| Tsuga h.  | 0.82         | 0.00         | 0.18        | 0.06          | 0.41         | 0.47         | 0.06          | 0.00       | 0.41       | 0.59        |

```{r, warning=FALSE, message=FALSE}
group_by(darkwoods_seedlings_data, species) %>%
  summarise(count = n(),
            mean = mean(elevation_asl, na.rm = TRUE),
            sd = sd(elevation_asl, na.rm = TRUE))

group_by(darkwoods_seedlings_data, plot123) %>%
  summarise(count = n(),
            mean = mean(elevation_asl, na.rm = TRUE),
            sd = sd(elevation_asl, na.rm = TRUE))

group_by(darkwoods_seedlings_data, species) %>%
  summarise(count = n(),
            mean = mean(slope, na.rm = TRUE),
            sd = sd(slope, na.rm = TRUE))

group_by(darkwoods_seedlings_data, plot123) %>%
  summarise(count = n(),
            mean = mean(slope, na.rm = TRUE),
            sd = sd(slope, na.rm = TRUE))

group_by(darkwoods_seedlings_data, species) %>%
  summarise(count = n(),
            mean = mean(rix, na.rm = TRUE),
            sd = sd(rix, na.rm = TRUE))

group_by(darkwoods_seedlings_data, plot123) %>%
  summarise(count = n(),
            mean = mean(rix, na.rm = TRUE),
            sd = sd(rix, na.rm = TRUE))

group_by(darkwoods_seedlings_data, species) %>%
  summarise(count = n(),
            mean = mean(aspect, na.rm = TRUE),
            sd = sd(aspect, na.rm = TRUE))

group_by(darkwoods_seedlings_data, plot123) %>%
  summarise(count = n(),
            mean = mean(aspect, na.rm = TRUE),
            sd = sd(aspect, na.rm = TRUE))

group_by(darkwoods_seedlings_data, species) %>%
  summarise(count = n(),
            mean = mean(twi, na.rm = TRUE),
            sd = sd(twi, na.rm = TRUE))

group_by(darkwoods_seedlings_data, plot123) %>%
  summarise(count = n(),
            mean = mean(twi, na.rm = TRUE),
            sd = sd(twi, na.rm = TRUE))

psych::describe(seedlings_allplots_sp$distance_m)
psych::describe(seedlings_plot1_sp$distance_m)
psych::describe(seedlings_plot2_sp$distance_m)
psych::describe(seedlings_plot3_sp$distance_m)

psych::describe(pinus_con_allplots_sp$distance_m)
psych::describe(larix_spp_allplots_sp$distance_m)
psych::describe(picea_eng_allplots_sp$distance_m)
psych::describe(pseudo_m_allplots_sp$distance_m)
psych::describe(pinus_pond_allplots_sp$distance_m)
psych::describe(pinus_monti_allplots_sp$distance_m)
psych::describe(tsuga_hete_allplots_sp$distance_m)
kruskal.test(distance_m ~ plot123, data = seedlings_allplots_sf)

#Plot disturbances
plot1_fire_beetle_table = table(seedlings_plot1_sp$mpb_class, seedlings_plot1_sp$fire_class)
prop.table(plot1_fire_beetle_table, 1)
prop.table(plot1_fire_beetle_table, 2)
table(seedlings_plot1_sp$fire_class)/length((seedlings_plot1_sp$fire_class))
table(seedlings_plot1_sp$mpb_class)/length((seedlings_plot1_sp$mpb_class))
table(seedlings_plot1_sp$bec_zone)/length((seedlings_plot1_sp$bec_zone))
psych::describe(seedlings_plot1_sp$wind)

plot2_fire_beetle_table = table(seedlings_plot2_sp$mpb_class, seedlings_plot2_sp$fire_class)
prop.table(plot2_fire_beetle_table, 1)
table(seedlings_plot2_sp$fire_class)/length((seedlings_plot2_sp$fire_class))
table(seedlings_plot2_sp$mpb_class)/length((seedlings_plot2_sp$mpb_class))
table(seedlings_plot2_sp$bec_zone)/length((seedlings_plot2_sp$bec_zone))
psych::describe(seedlings_plot2_sp$wind)

plot3_fire_beetle_table = table(seedlings_plot3_sp$mpb_class, seedlings_plot3_sp$fire_class)
prop.table(plot3_fire_beetle_table, 1)
table(seedlings_plot3_sp$fire_class)/length((seedlings_plot3_sp$fire_class))
table(seedlings_plot3_sp$mpb_class)/length((seedlings_plot3_sp$mpb_class))
table(seedlings_plot3_sp$bec_zone)/length((seedlings_plot3_sp$bec_zone))
psych::describe(seedlings_plot3_sp$wind)

#Disturbances across plots
table(darkwoods_seedlings_data$fire_class)/length((darkwoods_seedlings_data$fire_class))
table(darkwoods_seedlings_data$mpb_class)/length((darkwoods_seedlings_data$mpb_class))
table(darkwoods_seedlings_data$bec_zone)/length((darkwoods_seedlings_data$bec_zone))
table(darkwoods_seedlings_data$mpb_class)/length((darkwoods_seedlings_data$mpb_class))

#Disturbances between plots; ANOVA
kruskal.test(seedlings_allplots_sp$fire_class ~ seedlings_allplots_sp$plot123)
kruskal.test(seedlings_allplots_sp$fire_high ~ seedlings_allplots_sp$plot123)
kruskal.test(seedlings_allplots_sp$fire_med ~ seedlings_allplots_sp$plot123)
kruskal.test(seedlings_allplots_sp$fire_low ~ seedlings_allplots_sp$plot123)
#kruskal.test(seedlings_allplots_sp$fire_unburn ~ seedlings_allplots_sp$plot123)
kruskal.test(seedlings_allplots_sp$mpb_grey~ seedlings_allplots_sp$plot123)
kruskal.test(seedlings_allplots_sp$mpb_red~ seedlings_allplots_sp$plot123)

#Disturbance by species
#disturbance by pinus contorta
table(pinus_con_allplots_sp$mpb_class)/length((pinus_con_allplots_sp$mpb_class))
table(pinus_con_allplots_sp$fire_class)/length((pinus_con_allplots_sp$fire_class))
table(pinus_con_allplots_sp$bec_zone)/length((pinus_con_allplots_sp$bec_zone))
psych::describe(pinus_con_allplots_sp$wind)

#disturbance by Larix spp
table(larix_spp_allplots_sp$mpb_class)/length((larix_spp_allplots_sp$mpb_class))
table(larix_spp_allplots_sp$fire_class)/length((larix_spp_allplots_sp$fire_class))
table(larix_spp_allplots_sp$bec_zone)/length((larix_spp_allplots_sp$bec_zone))
psych::describe(larix_spp_allplots_sp$wind)

#disturbance by Picea engelmanii
table(picea_eng_allplots_sp$mpb_class)/length((picea_eng_allplots_sp$mpb_class))
table(picea_eng_allplots_sp$fire_class)/length((picea_eng_allplots_sp$fire_class))
table(picea_eng_allplots_sp$bec_zone)/length((picea_eng_allplots_sp$bec_zone))
psych::describe(picea_eng_allplots_sp$wind)

#disturbance by Pseudotsuga menziesii
table(pseudo_m_allplots_sp$mpb_class)/length((pseudo_m_allplots_sp$mpb_class))
table(pseudo_m_allplots_sp$fire_class)/length((pseudo_m_allplots_sp$fire_class))
table(pseudo_m_allplots_sp$bec_zone)/length((pseudo_m_allplots_sp$bec_zone))
psych::describe(pseudo_m_allplots_sp$wind)

#disturbance by Pinus ponderosa
table(pinus_pond_allplots_sp$mpb_class)/length((pinus_pond_allplots_sp$mpb_class))
table(pinus_pond_allplots_sp$fire_class)/length((pinus_pond_allplots_sp$fire_class))
table(pinus_pond_allplots_sp$bec_zone)/length((pinus_pond_allplots_sp$bec_zone))
psych::describe(pinus_pond_allplots_sp$wind)

#disturbance by Pinus monticola
table(pinus_monti_allplots_sp$mpb_class)/length((pinus_monti_allplots_sp$mpb_class))
table(pinus_monti_allplots_sp$fire_class)/length((pinus_monti_allplots_sp$fire_class))
table(pinus_monti_allplots_sp$bec_zone)/length((pinus_monti_allplots_sp$bec_zone))
psych::describe(pinus_monti_allplots_sp$wind)

#disturbance by tsuga heterphylla
table(tsuga_hete_allplots_sp$mpb_class)/length((pinus_monti_allplots_sp$mpb_class))
table(tsuga_hete_allplots_sp$fire_class)/length((pinus_monti_allplots_sp$fire_class))
table(tsuga_hete_allplots_sp$bec_zone)/length((pinus_monti_allplots_sp$bec_zone))
psych::describe(tsuga_hete_allplots_sp$wind)
```

## 3. Spatial Point Processes

### 3.1 Seedling Clustering

To identify spatial trends in dispersion and clustering patterns, we ran monte-carlo simulations of complete spatial randomness models (CSR), repeated 999 times and fitted with non-linear `Kinhom` kernel. Non-linear methods were employed after quadrat test, commented out below, which showed non-constant intensity by species and by plots.

We have not tested CSR of individual species within indivdual plots. There are likely advantages for MPB-hosts in plot 3 where there was no MPB-attacks found. For further tests of clustering, we commented out below functions to apply the Clark Evan's test of aggregation (1954) which is fitted with Donnelly's edge effects constraint (1978). This test is specifically suitable for rectangular field plots with long boundaries and strong edge risks similar to ours.

-   `Clark, P.J. and Evans, F.C. (1954) Distance to nearest neighbour as a measure of spatial relationships in populations Ecology 35, 445–453.`
-   `Donnelly, K. (1978) Simulations to determine the variance and edge-effect of total nearest neighbour distance. In I. Hodder (ed.) Simulation studies in archaeology, Cambridge/New York: Cambridge University Press, pp 91–95.`

```{r, warning=FALSE, message=FALSE}
# Quadrat test of intensity distribution
#Quadrat_seedlings_allplots <- quadrat.test(seedlings_allplots_ppp)
#Quadrat_seedlings_allplots
#Quadrat_seedlings_plot1 <- quadrat.test(seedlings_plot1_ppp)
#Quadrat_seedlings_plot1
#Quadrat_seedlings_plot2 <- quadrat.test(seedlings_plot2_ppp)
#Quadrat_seedlings_plot2
#Quadrat_seedlings_plot3 <- quadrat.test(seedlings_plot3_ppp)
#Quadrat_seedlings_plot3

mcarlo_kinhom999sim_plot1 = envelope(seedlings_plot1_ppp,
                                     Kinhom,
                                     nsim=999,
                                     correction="best",
                                     global = TRUE)
plot(mcarlo_kinhom999sim_plot1)

mcarlo_kest999sim_plot2 = envelope(seedlings_plot2_ppp,
                                   Kinhom,
                                   nsim=999,
                                   correction="best",
                                   global = TRUE)
plot(mcarlo_kest999sim_plot2)

mcarlo_kinhom999sim_plot3 = envelope(seedlings_plot3_ppp,
                                     Kinhom,
                                     nsim=999,
                                     correction="best",
                                     global = TRUE)
plot(mcarlo_kinhom999sim_plot3)

mcarlo_999sim_pinus_con = envelope(pinus_con_pooled,
                                   Kinhom,
                                   nsim = 999,
                                   correction="best",
                                   global = TRUE)
plot(mcarlo_999sim_pinus_con)

mcarlo_999sim_larix_spp = envelope(larix_spp_pooled,
                                   Kinhom,
                                   nsim = 999,
                                   correction="best",
                                   global = TRUE)
plot(mcarlo_999sim_larix_spp)

mcarlo_999sim_picea_eng = envelope(picea_eng_pooled,
                                   Kinhom,
                                   nsim = 999,
                                   correction="best",
                                   global = TRUE)
plot(mcarlo_999sim_picea_eng)

mcarlo_999sim_pseudo_m = envelope(pseudo_m_pooled,
                                  Kinhom,
                                  nsim = 999,
                                  correction="best",
                                  global = TRUE)
plot(mcarlo_999sim_pseudo_m)

mcarlo_999sim_pinus_pond = envelope(pinus_pond_pooled,
                                    Kinhom,
                                    nsim = 999,
                                    correction="best",
                                    global = TRUE)
plot(mcarlo_999sim_pinus_pond)

mcarlo_999sim_pinus_monti = envelope(pinus_monti_pooled,
                                    Kinhom,
                                    nsim = 999,
                                    correction="best",
                                    global = TRUE)
plot(mcarlo_999sim_pinus_monti)

mcarlo_999sim_tsuga_hete = envelope(tsuga_hete_pooled,
                                    Kinhom,
                                    nsim = 999,
                                    correction="best",
                                    global = TRUE)
plot(mcarlo_999sim_tsuga_hete)

#clarkevans.test(seedlings_allplots_ppp, nsim = 999)
#clarkevans.test(seedlings_plot1_ppp, nsim = 999)
#clarkevans.test(seedlings_plot2_ppp, nsim = 999)
#clarkevans.test(seedlings_plot3_ppp, nsim = 999)
#clarkevans.test(pinus_con_pooled, nsim = 999)
#clarkevans.test(larix_spp_pooled, nsim = 999)
#clarkevans.test(picea_eng_pooled, nsim = 999)
#clarkevans.test(pseudo_m_pooled, nsim = 999)
#clarkevans.test(pinus_pond_pooled, nsim = 999)
#clarkevans.test(pinus_monti_pooled, nsim = 999)
#clarkevans.test(tsuga_hete_pooled, nsim = 999)
```

### 3.2 Seedling Bandwidth Optimization

Bandwidth optimization is carried out with likelihood cross-validation test `bw.ppl` that ranges from 5.5 to 11.0 metres across plots and globally. Additional optimizer also available: `bw.diggle`.

```{r, fig.show='hold', out.width='25%', warning=FALSE, message=FALSE}
bw_likelihood_plot1 = bw.ppl(seedlings_plot1_ppp)
bw_likelihood_plot2 = bw.ppl(seedlings_plot2_ppp)
bw_likelihood_plot3 = bw.ppl(seedlings_plot3_ppp)
bw_likelihood_allplots = bw.ppl(seedlings_pooled)

plot(bw_likelihood_plot1, main="Plot 1 - LCV Bandwidth", xlim=c(0,16))
plot(bw_likelihood_plot2, main="Plot 2 - LCV Bandwidth", xlim=c(0,16))
plot(bw_likelihood_plot3, main="Plot 3 - LCV Bandwidth", xlim=c(0,16))
plot(bw_likelihood_allplots, main="Pooled - LCV Bandwidth", xlim=c(0,16))

#compute optimal bandwith - Diggle and Berman mean sq error cross validation method
#bw_diggle_plot1 = bw.diggle(seedlings_plot1_ppp)
#bw_diggle_plot2 = bw.diggle(seedlings_plot2_ppp)
#bw_diggle_plot3 = bw.diggle(seedlings_plot3_ppp)
#bw_diggle_allplots = bw.diggle(seedlings_allplots_ppp)
#plot(bw_diggle_plot1, main="Plot 1 - Diggle & Bearman CV-Bandwidth test")
#plot(bw_diggle_plot1, main="Plot 1 - Diggle & Bearman CV-Bandwidth test", xlim=c(0,1))
```

### 3.3 Seedling Point Processe Models

Terrain and climate covariates were screened for final inputs in the point-pattern-Cox-process model using Likelihood-Ratio-Test. This is quick and easy test to measure odds of prediction against intercept-only model. Similar to glmnet in section 1, covariates are dropped if their odds (or coefficients) are not impressive compared to zero-model. Anova analysis provides metric of statistical signficance.

Using the remaining best subset, a Cox-thomas model is fitted using `kppm` regression, with a previously optimized bandwidth as spatial threshold, and `isotropic` correction.

```{r, warning=FALSE, message=FALSE}
ppm_allplots = ppm(seedlings_allplots_ppp ~1, correction="isotropic") #intercept only model
ppm_allplots_distance_tree = ppm(seedlings_allplots_ppp ~ distance_tree_im,correction="isotropic")
ppm_allplots_elevation = ppm(seedlings_allplots_ppp ~ elevation_im, correction="isotropic")
ppm_allplots_aspect = ppm(seedlings_allplots_ppp ~ aspect_im, correction="isotropic")
ppm_allplots_slope = ppm(seedlings_allplots_ppp ~ slope_im, correction="isotropic")
ppm_allplots_rix = ppm(seedlings_allplots_ppp ~ rix_im, correction="isotropic")
ppm_allplots_twi = ppm(seedlings_allplots_ppp ~ twi_im, correction="isotropic")
ppm_allplots_wind = ppm(seedlings_allplots_ppp ~ wind_im, correction="isotropic")

anova(ppm_allplots, ppm_allplots_distance_tree, test = "LRT")
anova(ppm_allplots, ppm_allplots_elevation, test = "LRT") 
anova(ppm_allplots, ppm_allplots_slope, test = "LRT") #p=0.09702, dropped
anova(ppm_allplots, ppm_allplots_aspect, test = "LRT") 
anova(ppm_allplots, ppm_allplots_rix, test = "LRT")
anova(ppm_allplots, ppm_allplots_twi, test = "LRT")
anova(ppm_allplots, ppm_allplots_wind, test = "LRT")

marks(seedlings_pooled) <- NULL
marks(pinus_con_pooled) <- NULL
marks(larix_spp_pooled) <- NULL
marks(picea_eng_pooled) <- NULL
marks(pseudo_m_pooled) <- NULL
marks(pinus_pond_pooled) <- NULL
marks(pinus_monti_pooled) <- NULL
marks(tsuga_hete_pooled) <- NULL

ppm_seedlings_pooled = kppm(seedlings_pooled ~ distance_tree_im
                            + aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_pinus_con_pooled = kppm(pinus_con_pooled ~ distance_tree_im +
                              aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_larix_spp_pooled = kppm(larix_spp_pooled ~ distance_tree_im +
                              aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_picea_eng_pooled = kppm(picea_eng_pooled ~ distance_tree_im +
                              aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_pseudo_m_pooled = kppm(pseudo_m_pooled ~ distance_tree_im +
                             aspect_im + rix_im + wind_im +
                             mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                           "Thomas", kernel="epanechnikov", correction="isotropic",
                           sigma=bw_likelihood_allplots)

ppm_pinus_pond_pooled = kppm(pinus_pond_pooled ~ distance_tree_im +
                               aspect_im + rix_im + wind_im +
                             mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                           "Thomas", kernel="epanechnikov", correction="isotropic",
                           sigma=bw_likelihood_allplots)

ppm_pinus_monti_pooled = kppm(pinus_monti_pooled ~ distance_tree_im +
                                aspect_im + rix_im + wind_im +
                             mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                           "Thomas", kernel="epanechnikov", correction="isotropic",
                           sigma=bw_likelihood_allplots)

ppm_tsuga_hete_pooled = kppm(tsuga_hete_pooled ~ distance_tree_im +
                               aspect_im + rix_im + wind_im +
                             mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im,
                           "Thomas", kernel="epanechnikov", correction="isotropic",
                           sigma=bw_likelihood_allplots)

summary(ppm_seedlings_pooled)
summary(ppm_pinus_con_pooled)
summary(ppm_larix_spp_pooled)
summary(ppm_picea_eng_pooled)
summary(ppm_pseudo_m_pooled)
summary(ppm_pinus_pond_pooled)
summary(ppm_pinus_monti_pooled)
summary(ppm_tsuga_hete_pooled)
```

### 3.4 Alternative Mode: Disturbance Interactions

Alternative model `see_formula6.2` identified in section '1.1 Model Fitting' is tested below. This includes additional variables of disturbance interaction effects:

-   `mpb_red*fire_high`
-   `mpb_grey*fire_high`
-   `mpb_red*fire_low`
-   `mpb_grey*fire_low`

```{r, message=FALSE, warning=FALSE, error=FALSE}
ppm_seedlings_pooled_interaction = kppm(seedlings_pooled ~ distance_tree_im +
                              aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_pinus_con_pooled_interaction = kppm(pinus_con_pooled ~ distance_tree_im +
                              aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_larix_spp_pooled_interaction = kppm(larix_spp_pooled ~ distance_tree_im +
                              aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_picea_eng_pooled_interaction = kppm(picea_eng_pooled ~ distance_tree_im +
                              aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_pseudo_m_pooled_interaction = kppm(pseudo_m_pooled ~ distance_tree_im +
                             aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_pinus_pond_pooled_interaction = kppm(pinus_pond_pooled ~ distance_tree_im +
                               aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_pinus_monti_pooled_interaction = kppm(pinus_monti_pooled ~ distance_tree_im +
                                aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

ppm_tsuga_hete_pooled_interaction = kppm(tsuga_hete_pooled ~ distance_tree_im +
                               aspect_im + rix_im + wind_im +
                              mpb_grey_im + mpb_red_im + fire_high_im + fire_low_im + 
                              mpb_red_im*fire_high_im + mpb_red_im*fire_high_im + mpb_red_im*fire_low_im + mpb_red_im*fire_low_im,
                            "Thomas", kernel="epanechnikov", correction="isotropic",
                            sigma=bw_likelihood_allplots)

summary(ppm_seedlings_pooled_interaction)
summary(ppm_pinus_con_pooled_interaction)
summary(ppm_larix_spp_pooled_interaction)
summary(ppm_picea_eng_pooled_interaction)
summary(ppm_pseudo_m_pooled_interaction)
summary(ppm_pinus_pond_pooled_interaction)
summary(ppm_pinus_monti_pooled_interaction)
summary(ppm_tsuga_hete_pooled_interaction)
```
